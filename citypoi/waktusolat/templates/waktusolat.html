{% extends 'base.html' %}
{% load static %}

{% block content %}

<h1>Jadual Waktu Solat</h1>

<div id="map"></div>
<div id="prayer-times">
    <!-- Bootstrap Loader -->
    <div class="loader d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status">
        </div>
    </div>
</div>

<script>
    const zoneData = {{ zoneMapping|safe }};
    let userlat = '';
    let userlon = '';

    const mosqueIcon = L.icon({
        iconUrl: '/media/mosque.png',
        iconSize: [32, 32], // Size of the icon
        iconAnchor: [16, 32], // Point of the icon which will correspond to marker's location
        popupAnchor: [0, -32]
    })
    
    // Loader display functions
    function showLoader() {
        document.querySelector('.loader').style.display = 'flex';
    }

    function hideLoader() {
        document.querySelector('.loader').style.display = 'none';
    }

    showLoader();

    // MAP Initialization
    var map = L.map('map').setView([3.1390, 101.6869], 13);

    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    function getZoneCode(district) {
        for (const [zone, districts] of Object.entries(zoneData)) {
            if (districts.includes(district)) {
                return zone;
            }
        }
        return null; // Return null if the district is not found in any zone
    }

    //Geolocation
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(position) {
            userlat = position.coords.latitude;
            userlon = position.coords.longitude;

            map.setView([userlat, userlon], 13);

            const result = await reverseGeocode(userlat, userlon);

            if (result.error) {
                console.error(result.error);
                return;
            }

            const marker = L.marker([userlat, userlon]).addTo(map);
            const popupContent = `You are here!<br><br>
                                Address: ${result.address}<br><br>
                                District/City: ${result.district}<br>
                                Zone Code: ${result.zoneCode}`;

            marker.bindPopup(popupContent).openPopup();

            if (result.zoneCode) {
                fetchPrayerTimes(result.zoneCode);
                fetchNearestMosque(userlat, userlon);
            }
        }, function(error) {
            console.error("Geolocation error", error);
        });
    } else {
        console.log("Geolocation is not supported by this browser");
    }

    // reverse geocode 
    async function reverseGeocode(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.address) {
                const address = data.address;
                const addressString = [
                    address.road || '',
                    address.suburb || '',
                    address.city || '',
                    address.state || '',
                    address.country || ''
                ].filter(Boolean).join(', ');

                const district = address.district || address.city;
                let zoneCode = getZoneCode(district);

                if (!zoneCode) {
                    zoneCode = 'WLY01';
                }

                return {
                    address: addressString,
                    district: district,
                    zoneCode: zoneCode || 'Zone not found'
                };
            } else {
                return { error: 'Address not found' };
            }
        } catch (error) {
            console.error('Error with reverse geocoding:', error);
            return { error: 'Error retrieving address' };
        }
    }

    // fetch prayer times
    function fetchPrayerTimes(zoneCode) {
        const today = new Date().toISOString().split('T')[0];
        const url = `https://www.e-solat.gov.my/index.php?r=esolatApi/takwimsolat&period=duration&zone=${zoneCode}`;
        const payload = new URLSearchParams({
            datestart: today,
            dateend: today
        });

        fetch(url, {
            method: 'POST',
            body: payload
        })
        .then(response => response.json())
        .then(data => {
            hideLoader();
            if (data && data.prayerTime) {
                displayPrayerTimes(data.prayerTime);
            } else {
                document.getElementById('prayer-times').innerHTML = 'No prayer times found.';
            }
        })
        .catch(error => {
            console.error('Error fetching prayer times:', error);
            document.getElementById('prayer-times').innerHTML = 'Error retrieving prayer times.';
        });
    }

    function displayPrayerTimes(prayerTimes) {
        let html = '<table class="prayer-times-table"><tr><th>Date</th><th>Imsak</th><th>Fajr</th><th>Syuruk</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th></tr>';
        prayerTimes.forEach(time => {
            html += `<tr>
                <td>${time.date}</td>
                <td>${time.imsak}</td>
                <td>${time.fajr}</td>
                <td>${time.syuruk}</td>
                <td>${time.dhuhr}</td>
                <td>${time.asr}</td>
                <td>${time.maghrib}</td>
                <td>${time.isha}</td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById('prayer-times').innerHTML = html;
    }

    // fetch nearest mosque
    function fetchNearestMosque(lat, lon) {
        const url = `https://www.e-solat.gov.my/index.php?r=esolatApi/nearestMosque&lat=${lat}&long=${lon}&dist=5`;

        fetch(url, {
            method: 'GET',
        })
        .then(response => response.json())
        .then(data => {
            const mosques = data.locationData;
            if (mosques && mosques.length > 0) {
                addMosquesToMap(mosques);
            } else {
                console.log('No mosques found within the specified distance.');
            }
        })
        .catch(error => {
            console.error('Error fetching nearest mosques:', error);
        });
    }

    function addMosquesToMap(mosques) {
        const bounds = [];
        mosques.forEach(mosque => {
            const lat = parseFloat(mosque.latitud);
            const lon = parseFloat(mosque.longitud);
            const marker = L.marker([lat, lon], { icon: mosqueIcon }).addTo(map)
                .bindPopup(`<b>${mosque.nama_masjid}</b><br>${mosque.alamat}`);
            bounds.push([lat, lon]);
        });

        // Add the user's location to the bounds
        bounds.push([userlat, userlon]);

        // Fit the map view to the bounds
        map.fitBounds(bounds);
    }

</script>
{% endblock %}