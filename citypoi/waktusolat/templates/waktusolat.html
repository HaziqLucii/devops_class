{% extends 'base.html' %}
{% load static %}

{% block content %}

<h1>Jadual Waktu Solat</h1>

<div id="map"></div>
<div id="prayer-times">
    <!-- Bootstrap Loader -->
    <div class="loader d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status">
        </div>
    </div>
</div>

<script>
    const zoneData = {{ zoneMapping|safe }};
    
    // Loader display functions
    function showLoader() {
        document.querySelector('.loader').style.display = 'flex';
    }

    function hideLoader() {
        document.querySelector('.loader').style.display = 'none';
    }

    showLoader();

    // MAP Initialization
    var map = L.map('map').setView([3.1390, 101.6869], 13);

    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    function getZoneCode(district) {
        for (const [zone, districts] of Object.entries(zoneData)) {
            if (districts.includes(district)) {
                return zone;
            }
        }
        return null; // Return null if the district is not found in any zone
    }

    // reverse geocode 
    async function reverseGeocode(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.address) {
                const address = data.address;
                const addressString = [
                    address.road || '',
                    address.suburb || '',
                    address.city || '',
                    address.state || '',
                    address.country || ''
                ].filter(Boolean).join(', ');

                const district = address.district || address.city;
                let zoneCode = getZoneCode(district);

                if (!zoneCode) {
                    zoneCode = 'WLY01';
                }

                return {
                    address: addressString,
                    district: district,
                    zoneCode: zoneCode || 'Zone not found'
                };
            } else {
                return { error: 'Address not found' };
            }
        } catch (error) {
            console.error('Error with reverse geocoding:', error);
            return { error: 'Error retrieving address' };
        }
    }

    // fetch prayer times
    function fetchPrayerTimes(zoneCode) {
        const today = new Date().toISOString().split('T')[0];
        const url = `https://www.e-solat.gov.my/index.php?r=esolatApi/takwimsolat&period=duration&zone=${zoneCode}`;
        const payload = new URLSearchParams({
            datestart: today,
            dateend: today
        });

        fetch(url, {
            method: 'POST',
            body: payload
        })
        .then(response => response.json())
        .then(data => {
            hideLoader();
            if (data && data.prayerTime) {
                displayPrayerTimes(data.prayerTime);
            } else {
                document.getElementById('prayer-times').innerHTML = 'No prayer times found.';
            }
        })
        .catch(error => {
            console.error('Error fetching prayer times:', error);
            document.getElementById('prayer-times').innerHTML = 'Error retrieving prayer times.';
        });
    }

    function displayPrayerTimes(prayerTimes) {
        let html = '<table class="prayer-times-table"><tr><th>Date</th><th>Imsak</th><th>Fajr</th><th>Syuruk</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th></tr>';
        prayerTimes.forEach(time => {
            html += `<tr>
                <td>${time.date}</td>
                <td>${time.imsak}</td>
                <td>${time.fajr}</td>
                <td>${time.syuruk}</td>
                <td>${time.dhuhr}</td>
                <td>${time.asr}</td>
                <td>${time.maghrib}</td>
                <td>${time.isha}</td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById('prayer-times').innerHTML = html;
    }

    //Geolocation
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            map.setView([lat, lon], 13);

            const result = await reverseGeocode(lat, lon);

            if (result.error) {
                console.error(result.error);
                return;
            }

            const marker = L.marker([lat, lon]).addTo(map);
            const popupContent = `You are here!<br><br>
                                Address: ${result.address}<br><br>
                                District/City: ${result.district}<br>
                                Zone Code: ${result.zoneCode}`;

            marker.bindPopup(popupContent).openPopup();

            if (result.zoneCode) {
                fetchPrayerTimes(result.zoneCode);
            }
        }, function(error) {
            console.error("Geolocation error", error);
        });
    } else {
        console.log("Geolocation is not supported by this browser");
    }

</script>
{% endblock %}